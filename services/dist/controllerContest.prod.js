"use strict";var connection=require("../configs/database"),activityContest=require("./activityContest"),modelActivityContest=activityContest.modelActivityContest,modelControllerContest=connection.model("ControllerContest",{u_id:String,ac_url:String,ac_name:String,ac_description:String,ac_vote:Boolean,ac_updated:Date,ac_order:String});module.exports=modelControllerContest,module.exports={onInsert:function(t){return new Promise(function(n,e){var o=new modelControllerContest({u_id:t.u_id,ac_url:t.ac_url,ac_name:t.ac_name,ac_description:t.ac_description,ac_vote:t.ac_vote,ac_updated:Date.now()});o.save().then(function(t){return n(o)}).catch(function(t){return e(t)})})},shuffle:function(){return new Promise(function(i,u){modelControllerContest.find().countDocuments().then(function(t){for(var n=[],e=[],o=0,r=0;r<t;r++)n.push(r);for(var c=n.length;c--;)o=Math.floor(Math.random()*(c+1)),e.push(n[o]),n.splice(o,1);modelControllerContest.find().then(function(t){t.forEach(function(t,n){console.log(t.u_id+" = "+e[n]),modelControllerContest.update({u_id:t.u_id},{ac_order:e[n]},{multi:!0}).then(function(t){}).catch(function(t){return u(t)})}),i(t)}).catch(function(t){return u(t)}),i(e)}).catch(function(t){return u(t)})})},onOrder:function(r){return new Promise(function(n,e){var t={u_id:r.u_id},o={ac_order:r.ac_order};modelControllerContest.update(t,o,{multi:!0}).then(function(t){n(t)}).catch(function(t){return e(t)})})},findOne:function(t){return new Promise(function(n,e){modelControllerContest.find({u_id:t.id}).then(function(t){n(t[0])}).catch(function(t){return e(t)})})},findAll:function(t){return new Promise(function(n,e){var o={result:[]},r={};t.search_key&&t.search_text&&(r[t.search_key]={$regex:t.search_text,$options:"i"}),modelControllerContest.find(r).sort({u_id:-1}).then(function(t){console.log(t),o.result=t,modelControllerContest.find(r).countDocuments().then(function(t){o.rows=t,n(o)}).catch(function(t){return e(t)})}).catch(function(t){return e(t)})})},findByVote:function(i){return new Promise(function(n,e){var t=12*((i.page||1)-1),o={result:[],rows:0,limit:12},r={},c=-1;"asc"==i.sort?c=1:"desc"==i.sort&&(c=-1),i.search_key&&i.search_text&&(r[i.search_key]={$regex:i.search_text,$options:"i"}),modelControllerContest.aggregate([{$lookup:{from:"activitycontests",localField:"u_id",foreignField:"ac_id",as:"acv"}},{$match:r},{$project:{u_id:1,ac_url:1,ac_name:1,ac_description:1,ac_vote:1,ac_updated:1,acv:{$size:"$acv"}}},{$sort:{acv:c}}]).skip(t).limit(12).then(function(t){o.result=t,modelControllerContest.find(r).countDocuments().then(function(t){o.rows=t,n(o)}).catch(function(t){return e(t)})}).catch(function(t){return e(t)})})},findByOrder:function(c){return new Promise(function(n,e){var t=12*((c.page||1)-1),o={result:[],rows:0,limit:12},r={};c.search_key&&c.search_text&&(r[c.search_key]={$regex:c.search_text,$options:"i"}),modelControllerContest.find(r).skip(t).sort({ac_order:-1}).limit(12).then(function(t){console.log(t),o.result=t,modelControllerContest.find(r).countDocuments().then(function(t){o.rows=t,n(o)}).catch(function(t){return e(t)})}).catch(function(t){return e(t)})})},onEnableVideoVote:function(r){return new Promise(function(n,e){var t={u_id:id},o={ac_vote:r.ac_vote};modelControllerContest.update(t,o,{multi:!0}).then(function(t){n(t)}).catch(function(t){return e(t)})})},onDelete:function(t){return new Promise(function(n,e){modelControllerContest.deleteOne({u_id:t}).then(function(t){n(t)}).catch(function(t){return e(t)})})}};