"use strict";var connection=require("../configs/database"),_require=require("../configs/security"),password_hash=_require.password_hash,password_verify=_require.password_verify,isEmpty=_require.isEmpty,serviceVideo=require("../services/activityVideo"),activityContest=require("../services/activityContest"),modelActivityContest=activityContest.modelActivityContest,modelUser=connection.model("User",{u_id:String,u_password:String,u_username:String,u_lastname:String,u_nickname:String,u_school:String,u_major:String,u_blood:String,u_religion:String,u_thumbnail:String});module.exports={onRegister:function(e){return new Promise(function(n,i){e.u_password=password_hash(e.u_password),new modelUser({u_id:e.u_id,u_username:e.u_username,u_password:e.u_password,u_faculty:e.u_faculty}).save().then(function(e){return n({status:"registered"})}).catch(function(e){return i({status:"cannot registered"})})})},onGroupActivity:function(){return new Promise(function(n,i){modelUser.find().countDocuments().then(function(e){n(e)}).catch(function(e){return i(e)})})},onSummary:function(){return new Promise(function(n,i){modelUser.aggregate([{$lookup:{from:"activitycontests",localField:"u_id",foreignField:"acv_u_id",as:"acv"}},{$unwind:{path:"$acv",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"activitypaintings",localField:"u_id",foreignField:"u_id",as:"acp"}},{$unwind:{path:"$acp",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"activityflowers",localField:"u_id",foreignField:"u_id",as:"af"}},{$unwind:{path:"$af",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"activitywalkrallies",localField:"u_id",foreignField:"u_id",as:"aw"}},{$unwind:{path:"$aw",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"activityvideos",localField:"u_id",foreignField:"u_id",as:"av"}},{$unwind:{path:"$av",preserveNullAndEmptyArrays:!0}},{$group:{_id:"$_id",u_id:{$first:"$u_id"},acp:{$first:"$acp._id"},af:{$first:"$af._id"},aw:{$first:"$aw._id"},acv:{$first:"$acv._id"},av:{$push:"$av"}}},{$project:{u_id:1,activity:[{id:"activity1",name:"Follow The Path",done:{$cond:{if:{$in:["Follow The Path","$av.av_name"]},then:1,else:0}}},{id:"activity2",name:"Lamduan Flower",done:{$cond:{if:{$ne:["$af",null]},then:1,else:0}}},{id:"activity3",name:"Walk Rally",done:{$cond:{if:{$ne:["$aw",null]},then:1,else:0}}},{id:"activity4",name:"Khantok",done:{$cond:{if:{$in:["Khantok","$av.av_name"]},then:1,else:0}}},{id:"activity5",name:"Set Your Goal",done:{$cond:{if:{$in:["Set Your Goal","$av.av_name"]},then:1,else:0}}},{id:"activity6",name:"Smart Learner",done:{$cond:{if:{$in:["Smart Learner","$av.av_name"]},then:1,else:0}}},{id:"activity7",name:"Teen Lesson",done:{$cond:{if:{$in:["Teen Lesson","$av.av_name"]},then:1,else:0}}},{id:"activity9",name:"Inspiration",done:{$cond:{if:{$in:["Inspiration","$av.av_name"]},then:1,else:0}}},{id:"activity10",name:"Painting",done:{$cond:{if:{$ne:["$acp",null]},then:1,else:0}}},{id:"activity12",name:"Content Contest",done:{$cond:{if:{$ne:["$acv",null]},then:1,else:0}}}]}},{$sort:{_id:1}}]).then(function(e){n(e)}).catch(function(e){return i(e)})})},getAllStudent:function(){return new Promise(function(n,i){modelUser.find().then(function(e){n(e)}).catch(function(e){return i(e)})})},onUpdate:function(a){return new Promise(function(n,i){var e={u_id:a.id},t={u_thumbnail:a.thumbnail};modelUser.update(e,t,{multi:!0}).then(function(e){n(e)}).catch(function(e){return i(e)})})},onLogin:function(e){return new Promise(function(n,i){modelUser.find({u_id:e.u_id,u_password:e.u_password}).select("-u_password").then(function(e){isEmpty(e)?n({message:"Authen fail"}):n(e[0])}).catch(function(e){return i(e)})})}};